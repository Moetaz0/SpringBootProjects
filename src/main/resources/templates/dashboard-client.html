<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MedLink — Client Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      :root {
        --brand: #0d9488; /* teal */
        --brand-600: #0f766e;
        --accent: #2dd4bf;
        --bg: linear-gradient(180deg, #f7fdfa 0%, #f0fdfa 100%);
        --card-bg: rgba(255, 255, 255, 0.9);
        --muted: #6b7280;
        --text: #0f172a;
        --border: rgba(15, 23, 42, 0.08);
        --shadow: 0 10px 30px rgba(13, 110, 253, 0.06);
      }
      .mh-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
        margin-top: 10px;
      }

      .mh-card {
        padding: 16px;
        border-radius: 12px;
        background: var(--card-bg, #fff);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s;
      }

      body.dark .mh-card {
        background: #1e1e1e;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.4);
      }

      .mh-card:hover {
        transform: translateY(-3px);
      }

      .mh-card h3 {
        margin: 0 0 6px 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .mh-card p {
        margin: 0;
        font-size: 14px;
        color: var(--muted-text, #555);
      }

      .mh-card.small {
        padding: 14px;
      }

      .mh-card.full {
        grid-column: 1 / -1;
      }

      body.dark {
        --bg: linear-gradient(180deg, #031017 0%, #02121a 100%);
        --card-bg: rgba(37, 39, 41, 0.7);
        --muted: #9fb6bb;
        --text: #cac5c5ff;
        --border: rgba(255, 255, 255, 0.06);
        --shadow: 0 12px 40px rgba(2, 10, 12, 0.6);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          Arial;
        background: var(--bg);
        -webkit-font-smoothing: antialiased;
        color: var(--text);
      }
      .app {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
        .card > strong {
          font-weight: 700;
          letter-spacing: 0.2px;
        }
        .section-title {
          font-size: 20px;
          font-weight: 700;
          margin: 0 0 8px 0;
        }
      }
      .sidebar {
        background: var(--card-bg);
        .col-5 {
          grid-column: span 5;
        }
        border-right: 1px solid var(--border);
        box-shadow: var(--shadow);
        input.btn,
        select.btn {
          transition: border-color 0.2s, box-shadow 0.2s;
        }
        input.btn:focus,
        select.btn:focus {
          outline: none;
          border-color: var(--brand-600);
          box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }
        label.muted {
          display: block;
          margin-bottom: 6px;
        }
        .actions-row {
          display: flex;
          gap: 8px;
          align-items: center;
          flex-wrap: wrap;
        }
        .status {
          font-size: 12px;
        }
        padding: 20px 16px;
        position: sticky;
        top: 0;
        height: 100vh;
      }
      .brand {
        display: flex;
        align-items: center;
        justify-content: center; /* center horizontally in the aside */
        gap: 12px;
        margin: 14px 0 24px 0;
        font-weight: 800;
        color: var(--brand-600);
        font-size: 1.25rem; /* slightly larger text */
        width: 100%;
      }

      /* make icon a bit bigger and keep proper alignment */
      .brand i {
        font-size: 1.4rem;
        line-height: 1;
      }
      .nav {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
      }
      .nav a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        margin-bottom: 6px;
        border-radius: 10px;
        color: var(--text);
        text-decoration: none;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.6);
      }
      .nav a:hover {
        border-color: var(--brand-600);
        box-shadow: 0 6px 18px rgba(13, 148, 136, 0.12);
      }
      .nav a.active {
        background: linear-gradient(90deg, var(--brand), var(--accent));
        color: #fff;
        border: none;
      }
      .main {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .main .kpis {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
      }
      .kpi {
        grid-column: span 4;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 14px;
      }
      .kpi .label {
        font-size: 12px;
        color: var(--muted);
      }
      .kpi .value {
        font-size: 24px;
        font-weight: 800;
        margin-top: 4px;
        color: var(--brand-600);
      }
      .kpi .sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-8 {
        grid-column: span 8;
      }
      .btn {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 14px;
        background: #fff;
        cursor: pointer;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--brand), var(--accent));
        color: #fff;
        border: none;
      }
      .muted {
        color: var(--muted);
      }

      /* Map & search specific */
      .doctor-map {
        width: 100%;
        height: 480px;
        border-radius: 10px;
        overflow: hidden;
      }
      .doctor-results {
        max-height: 480px;
        overflow: auto;
        display: grid;
        gap: 8px;
      }
      .doctor-card {
        padding: 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid var(--border);
      }
      .doctor-card button {
        margin-left: 6px;
      }
      /* Minimal WhatsApp-like style */
      .chat-container {
        display: flex;
        gap: 16px;
        height: 520px;
      }
      .chat-sidebar {
        width: 300px;
        border-right: 1px solid rgba(0, 0, 0, 0.06);
        padding: 12px;
        box-sizing: border-box;
      }
      .chat-header {
        font-weight: 700;
        margin-bottom: 8px;
      }
      .conversations {
        overflow-y: auto;
        height: calc(100% - 40px);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .conv {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .conv:hover {
        background: rgba(0, 0, 0, 0.03);
      }
      .conv .meta {
        flex: 1;
      }
      .conv .meta .name {
        font-weight: 600;
      }
      .conv .meta .last {
        font-size: 12px;
        color: var(--muted);
      }

      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .chat-topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }
      .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: linear-gradient(180deg, #f7f7f7, #fff);
      }
      .messages-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 960px;
        margin: 0 auto;
      }

      .msg {
        max-width: 70%;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.3;
      }
      .msg.me {
        background: linear-gradient(90deg, var(--brand), var(--accent));
        color: #fff;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }
      .msg.them {
        background: #fff;
        color: var(--text);
        border: 1px solid rgba(0, 0, 0, 0.06);
        margin-right: auto;
        border-bottom-left-radius: 4px;
      }

      .msg .meta {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
      }
      .chat-form {
        display: flex;
        gap: 8px;
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
      }
      #msg-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--brand), var(--accent));
        color: #fff;
        border: none;
      }

      @media (max-width: 980px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: relative;
          height: auto;
        }
        .doctor-map {
          height: 320px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <i
            class="bi bi-heart-pulse-fill center"
            style="color: var(--brand)"
          ></i>
          MedLink
        </div>
        <div
          style="
            display: flex;
            align-items: left;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
          "
        >
          <div
            style="
              display: flex;
              width: 100%;
              justify-content: space-between;
              gap: 8px;
              margin-bottom: 10px;
            "
          ></div>
        </div>
        <nav>
          <ul class="nav">
            <li>
              <a href="#overview" data-section="overview" class="active"
                ><i class="bi bi-grid-1x2-fill"></i> Overview</a
              >
            </li>
            <li>
              <a href="#prescriptions" data-section="prescriptions"
                ><i class="bi bi-capsule-pill"></i> My prescriptions</a
              >
            </li>
            <li>
              <a href="#history" data-section="history"
                ><i class="bi bi-file-medical"></i> My medical history</a
              >
            </li>
            <li>
              <a href="#messages" data-section="messages"
                ><i class="bi bi-chat-dots"></i> Messages</a
              >
            </li>
            <li>
              <a href="#search" data-section="search"
                ><i class="bi bi-search"></i> Search doctors</a
              >
            </li>
            <li>
              <a href="#settings" data-section="settings"
                ><i class="bi bi-gear"></i> Settings</a
              >
            </li>
            <li>
              <a href="#logout" id="logout"
                ><i class="bi bi-box-arrow-right"></i> Logout</a
              >
            </li>
          </ul>
        </nav>
      </aside>
      <main class="main">
        <div class="topbar">
          <h1 id="dashboard-title" style="margin: 0">Client Dashboard</h1>
        </div>
        <div
          style="
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 9999;
            display: flex;
            gap: 8px;
            align-items: center;
          "
        >
          <button
            id="notif-btn"
            class="btn"
            title="Notifications"
            style="position: relative; padding: 8px"
          >
            <i class="bi bi-bell"></i>
            <span
              id="notif-count"
              style="
                position: absolute;
                top: -6px;
                right: -6px;
                background: #ef4444;
                color: #fff;
                font-size: 11px;
                padding: 2px 6px;
                border-radius: 999px;
                display: none;
              "
              >0</span
            >
          </button>

          <button
            id="theme-toggle"
            class="btn"
            title="Toggle theme"
            style="padding: 8px"
          >
            <i id="theme-icon" class="bi bi-moon-fill"></i>
          </button>
        </div>

        <section id="section-overview" class="card">
          <h2 class="section-title">Overview</h2>
          <div class="kpis" style="margin-top: 4px">
            <div class="kpi">
              <div class="label">Prescriptions</div>
              <div class="value" id="stat-prescriptions">—</div>
              <div class="sub">Active and pending</div>
            </div>
            <div class="kpi">
              <div class="label">Lab Results</div>
              <div class="value" id="stat-labs">—</div>
              <div class="sub">Recent results</div>
            </div>
            <div class="kpi">
              <div class="label">Appointments</div>
              <div class="value" id="stat-appointments">—</div>
              <div class="sub">Upcoming visits</div>
            </div>
          </div>
        </section>

        <section id="section-prescriptions" class="card" style="display: none">
          <h2 class="section-title">My prescriptions</h2>
          <div class="grid" style="align-items: end; margin-bottom: 8px">
            <div class="col-4">
              <label class="muted">Search</label>
              <input
                id="rx-search"
                class="btn"
                type="text"
                placeholder="Search by medication or doctor"
                style="width: 100%"
              />
            </div>
            <div class="col-3">
              <label class="muted">Status</label>
              <select id="rx-status" class="btn" style="width: 100%">
                <option value="">All</option>
                <option value="PENDING">Pending</option>
                <option value="ACTIVE">Active</option>
                <option value="EXPIRED">Expired</option>
                <option value="REFILL_REQUESTED">Refill requested</option>
              </select>
            </div>
            <div class="col-2">
              <label class="muted">From</label>
              <input id="rx-from" class="btn" type="date" style="width: 100%" />
            </div>
            <div class="col-2">
              <label class="muted">To</label>
              <input id="rx-to" class="btn" type="date" style="width: 100%" />
            </div>
            <div class="col-1">
              <button id="rx-clear" class="btn" style="width: 100%">
                Clear
              </button>
            </div>
          </div>
          <div
            id="rx-list"
            class="grid"
            style="grid-template-columns: repeat(12, 1fr); gap: 12px"
          >
            <!-- items injected here -->
          </div>
          <div
            id="rx-empty"
            class="muted"
            style="margin-top: 8px; display: none"
          >
            No prescriptions found.
          </div>
        </section>

        <section id="section-history" class="card" style="display: none">
          <h2 style="margin: 0 0 8px 0">My Medical History</h2>
          <p class="muted">Visits, conditions, medications & test results.</p>

          <!-- Medical Information -->
          <h3 style="margin-top: 20px">General Information</h3>
          <div id="mh-info" class="muted">Loading...</div>

          <!-- Appointments -->
          <h3 style="margin-top: 20px">Past Appointments</h3>
          <div id="mh-appointments" class="muted">Loading...</div>

          <!-- Lab Results -->
          <h3 style="margin-top: 20px">Lab Results</h3>
          <div id="mh-labs" class="muted">Loading...</div>
        </section>

        <!-- Messages section (WhatsApp style) -->
        <section id="section-messages" class="card" style="display: none">
          <div class="chat-container">
            <div class="chat-sidebar">
              <div class="chat-header">
                <strong>Messages</strong>
              </div>
              <div id="conversations" class="conversations"></div>
            </div>

            <div class="chat-main">
              <div class="chat-topbar">
                <div id="chat-with" class="chat-with">
                  Select a conversation
                </div>
                <div class="chat-actions">
                  <button id="start-new" class="btn">New</button>
                </div>
              </div>

              <div id="chat-window" class="chat-window">
                <div id="messages-list" class="messages-list"></div>
              </div>

              <form id="chat-form" class="chat-form" onsubmit="return false;">
                <input
                  id="msg-input"
                  autocomplete="off"
                  placeholder="Type a message"
                />
                <button id="send-btn" class="btn btn-primary">Send</button>
              </form>
            </div>
          </div>
        </section>

        <!-- New Search doctors section -->
        <section id="section-search" class="card" style="display: none">
          <h2 class="section-title">Find a doctor</h2>
          <p class="muted">
            Search doctors on the map and filter by specialty, distance and
            rating.
          </p>

          <div class="grid" style="margin-top: 12px; align-items: start">
            <div class="col-4">
              <div style="display: grid; gap: 8px">
                <div>
                  <label class="muted">Search</label>
                  <input
                    id="doc-search"
                    class="btn"
                    type="text"
                    placeholder="Name or clinic"
                    style="width: 100%"
                  />
                </div>
                <div>
                  <label class="muted">Specialty</label>
                  <select id="doc-specialty" class="btn" style="width: 100%">
                    <option value="">Any</option>
                    <option>General Practitioner</option>
                    <option>Cardiology</option>
                    <option>Dermatology</option>
                    <option>Pediatrics</option>
                    <option>Psychiatry</option>
                  </select>
                </div>
                <div style="display: flex; gap: 8px">
                  <div style="flex: 1">
                    <label class="muted">Max distance (km)</label>
                    <select id="doc-distance" class="btn" style="width: 100%">
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                    </select>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center">
                  <button id="doc-search-btn" class="btn btn-primary">
                    Search
                  </button>
                  <button id="doc-clear-btn" class="btn">Clear</button>
                </div>
                <div
                  id="doc-status"
                  class="muted"
                  style="margin-top: 6px"
                ></div>

                <div style="margin-top: 8px">
                  <strong>Results</strong>
                  <div
                    id="doctor-results"
                    class="doctor-results"
                    style="margin-top: 8px"
                  >
                    <!-- doctor cards added here -->
                  </div>
                </div>
              </div>
            </div>

            <div class="col-8">
              <div id="doctor-map" style="width: 100%; height: 500px"></div>
            </div>
          </div>
        </section>

        <section id="section-settings" class="card" style="display: none">
          <h2 class="section-title">Settings</h2>
          <p class="muted">Manage account preferences.</p>
          <div class="grid" style="margin-top: 8px">
            <div class="col-8 col-5">
              <div class="card">
                <strong>General</strong>
                <form id="profile-form" style="margin-top: 8px">
                  <div
                    class="grid"
                    style="grid-template-columns: repeat(3, 1fr); gap: 12px"
                  >
                    <div style="grid-column: 1; grid-row: 1">
                      <label class="muted">Name</label>
                      <input
                        id="inp-name"
                        class="btn"
                        type="text"
                        placeholder="Full name"
                        style="width: 100%"
                      />
                    </div>
                    <div style="grid-column: 1; grid-row: 2">
                      <label class="muted">Phone</label>
                      <input
                        id="inp-phone"
                        class="btn"
                        type="text"
                        placeholder="Phone number"
                        style="width: 100%"
                      />
                    </div>
                    <div style="grid-column: 1; grid-row: 3">
                      <label class="muted">Email</label>
                      <input
                        id="inp-email"
                        class="btn"
                        type="email"
                        placeholder="email@example.com"
                        style="width: 100%"
                      />
                    </div>

                    <div
                      style="grid-column: 1 / span 3; margin-top: 10px"
                      class="actions-row"
                    >
                      <button type="submit" class="btn btn-primary">
                        Save changes
                      </button>
                      <span id="profile-status" class="muted status"></span>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="col-4">
              <div class="card">
                <strong>Security</strong>
                <form id="password-form" style="margin-top: 8px">
                  <label class="muted">Current password</label>
                  <input
                    id="pwd-current"
                    class="btn"
                    type="password"
                    placeholder="Current password"
                    style="width: 100%"
                  />
                  <label class="muted" style="margin-top: 6px; display: block"
                    >New password</label
                  >
                  <input
                    id="pwd-new"
                    class="btn"
                    type="password"
                    placeholder="New password"
                    style="width: 100%"
                  />
                  <div class="actions-row" style="margin-top: 10px">
                    <button type="submit" class="btn btn-primary">
                      Update password
                    </button>
                    <span id="password-status" class="muted status"></span>
                  </div>
                </form>
              </div>
              <div class="card" style="margin-top: 12px">
                <strong>Preferences</strong>
                <div
                  style="
                    margin-top: 8px;
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 12px;
                  "
                >
                  <div>
                    <label class="muted">Language</label>
                    <select id="pref-language" class="btn" style="width: 100%">
                      <option value="en">English</option>
                      <option value="fr">Français</option>
                      <option value="ar">العربية</option>
                    </select>
                  </div>
                  <div>
                    <label class="muted">Theme</label>
                    <select id="pref-theme" class="btn" style="width: 100%">
                      <option value="system">System</option>
                      <option value="light">Light</option>
                      <option value="dark">Dark</option>
                    </select>
                  </div>
                </div>
                <div class="actions-row" style="margin-top: 10px">
                  <button class="btn" id="save-prefs">Save preferences</button>
                  <button class="btn" id="clear-cache">Clear cache</button>
                  <button class="btn" id="clear-token">Clear token</button>
                  <span id="prefs-status" class="muted status"></span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      (() => {
        // ---------------------------
        // AUTHENTICATION
        // ---------------------------
        const token = localStorage.getItem("authToken");
        if (!token) return (location.href = "/auth/login");

        function parseToken(t) {
          try {
            return JSON.parse(
              atob(t.split(".")[1].replace(/-/g, "+").replace(/_/g, "/"))
            );
          } catch {
            return null;
          }
        }

        const payload = parseToken(token);
        const myId = payload?.userId;
        if (!myId) return (location.href = "/auth/login");

        // ---------------------------
        // HELPERS
        // ---------------------------
        function escapeHtml(s) {
          return (s || "")
            .toString()
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;");
        }

        function scrollToBottom() {
          setTimeout(() => {
            const chatWindow = document.getElementById("chat-window");
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
          }, 50);
        }

        async function fetchJson(url) {
          try {
            const res = await fetch(url, {
              headers: { Authorization: `Bearer ${token}` },
            });
            return res.ok ? await res.json() : null;
          } catch (e) {
            console.error(e);
            return null;
          }
        }

        // ---------------------------
        // SPA SECTION SWITCHING
        // ---------------------------
        const sections = {
          overview: document.getElementById("section-overview"),
          prescriptions: document.getElementById("section-prescriptions"),
          history: document.getElementById("section-history"),
          messages: document.getElementById("section-messages"),
          search: document.getElementById("section-search"),
          settings: document.getElementById("section-settings"),
        };
        const links = document.querySelectorAll(".nav a[data-section]");

        function showSection(sec) {
          Object.entries(sections).forEach(
            ([k, el]) => el && (el.style.display = k === sec ? "" : "none")
          );
          links.forEach((a) =>
            a.classList.toggle("active", a.getAttribute("data-section") === sec)
          );
          history.replaceState
            ? history.replaceState(null, null, `#${sec}`)
            : (location.hash = sec);
          localStorage.setItem("medlink-active-section", sec);
        }

        links.forEach((a) => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            showSection(a.getAttribute("data-section"));
          });
        });

        window.addEventListener("hashchange", () => {
          const hashSec = location.hash.replace("#", "");
          if (hashSec && sections[hashSec]) showSection(hashSec);
        });

        document.addEventListener("DOMContentLoaded", () => {
          const lastSec =
            localStorage.getItem("medlink-active-section") || "overview";
          showSection(lastSec);
        });

        // ---------------------------
        // USER DETAILS
        // ---------------------------
        async function loadUserDetails() {
          const user = await fetchJson(`/users/${myId}`);
          if (!user) return;
          document.getElementById("inp-name").value = user.username || "";
          document.getElementById("inp-email").value = user.email || "";
          document.getElementById("inp-phone").value = user.phoneNumber || "";
          document.getElementById(
            "dashboard-title"
          ).textContent = `${user.username}, Dashboard`;
          sessionStorage.setItem("uid", myId);
        }
        loadUserDetails();

        // ---------------------------
        // THEME TOGGLE
        // ---------------------------
        const storageKey = "medlink-theme";
        const body = document.body;
        const toggle = document.getElementById("theme-toggle");
        const icon = document.getElementById("theme-icon");

        function setIcon(isDark) {
          if (icon)
            icon.className = isDark ? "bi bi-sun-fill" : "bi bi-moon-fill";
        }
        function applyTheme(isDark) {
          isDark ? body.classList.add("dark") : body.classList.remove("dark");
          setIcon(isDark);
        }

        document.addEventListener("DOMContentLoaded", () => {
          const stored = localStorage.getItem(storageKey);
          const prefersDark = window.matchMedia?.(
            "(prefers-color-scheme: dark)"
          ).matches;
          const isDark = stored ? stored === "dark" : prefersDark;
          applyTheme(isDark);
          if (!stored && window.matchMedia) {
            window
              .matchMedia("(prefers-color-scheme: dark)")
              .addEventListener("change", (e) => applyTheme(e.matches));
          }
        });

        toggle?.addEventListener("click", () => {
          const isDark = body.classList.toggle("dark");
          localStorage.setItem(storageKey, isDark ? "dark" : "light");
          setIcon(isDark);
        });

        // ---------------------------
        // LOGOUT
        // ---------------------------
        document.getElementById("logout")?.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("authToken");
          location.href = "/auth/login";
        });

        // ---------------------------
        // MESSAGES
        // ---------------------------
        const sectionMessages = document.getElementById("section-messages");
        const convContainer = document.getElementById("conversations");
        const chatWithEl = document.getElementById("chat-with");
        const messagesList = document.getElementById("messages-list");
        const msgInput = document.getElementById("msg-input");
        const sendBtn = document.getElementById("send-btn");

        let conversations = [];
        let activeConversation = null;
        let stompClient = null;

        async function loadConversations() {
          const data = await fetchJson(`/api/chats/${myId}/conversations`);
          if (data) {
            conversations = data;
            renderConversations();
          }
        }

        function renderConversations() {
          convContainer.innerHTML = "";
          conversations.forEach((c) => {
            const el = document.createElement("div");
            el.className = "conv";
            el.dataset.other = c.otherId;
            el.innerHTML = `<div class="meta">
          <div class="name">${escapeHtml(c.name || "User " + c.otherId)}</div>
          <div class="last">${escapeHtml(c.lastMessage || "")}</div>
        </div>`;
            el.addEventListener("click", () =>
              openConversation(c.otherId, c.name)
            );
            convContainer.appendChild(el);
          });
        }

        async function openConversation(otherId, otherName) {
          activeConversation = otherId;
          chatWithEl.textContent = otherName || "User " + otherId;
          messagesList.innerHTML = '<div class="muted">Loading...</div>';
          const data = await fetchJson(`/api/chats/${myId}/with/${otherId}`);
          renderMessages(data || []);
        }

        function renderMessages(msgs) {
          messagesList.innerHTML = "";
          msgs.forEach(appendMessageToList);
          scrollToBottom();
        }

        function appendMessageToList(m) {
          const div = document.createElement("div");
          div.className = "msg " + (m.senderId === myId ? "me" : "them");
          div.innerHTML = `<div class="body">${escapeHtml(m.content)}</div>
                     <div class="meta">${new Date(
                       m.timestamp
                     ).toLocaleString()}</div>`;
          messagesList.appendChild(div);
        }

        function handleIncomingMessage(m) {
          if (
            m.senderId === activeConversation ||
            m.receiverId === activeConversation
          ) {
            appendMessageToList(m);
            scrollToBottom();
          } else {
            const otherId = m.senderId === myId ? m.receiverId : m.senderId;
            const idx = conversations.findIndex((c) => +c.otherId === +otherId);
            if (idx === -1)
              conversations.unshift({
                otherId,
                name: "User " + otherId,
                lastMessage: m.content,
              });
            else {
              conversations[idx].lastMessage = m.content;
              conversations.unshift(conversations.splice(idx, 1)[0]);
            }
            renderConversations();
          }
        }

        function connectWs() {
          const socket = new SockJS("/chat");
          stompClient = Stomp.over(socket);
          stompClient.connect(
            { Authorization: `Bearer ${token}` },
            () => {
              stompClient.subscribe("/user/queue/messages", (frame) =>
                handleIncomingMessage(JSON.parse(frame.body))
              );
            },
            (err) => console.error("WS connect error", err)
          );
        }

        function sendMessage() {
          if (!stompClient || !activeConversation) return;
          const content = msgInput.value.trim();
          if (!content) return;
          const payload = {
            senderId: myId,
            receiverId: activeConversation,
            content,
          };
          stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
          payload.timestamp = new Date().toISOString();
          appendMessageToList(payload);
          scrollToBottom();
          msgInput.value = "";
        }

        sendBtn?.addEventListener("click", sendMessage);
        msgInput?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendMessage();
        });

        sectionMessages &&
          sectionMessages.addEventListener("click", loadConversations);
        connectWs();

        // ---------------------------
        // MEDICAL HISTORY
        // ---------------------------
        async function fetchMedicalHistory() {
          const mh = await fetchJson(`/api/history/user/${myId}`);
          if (!mh) {
            document.getElementById("mh-info").textContent =
              "No medical history available.";
            return;
          }

          document.getElementById("mh-info").innerHTML = `
      <div class="mh-grid">
        <div class="mh-card"><h3><i class="bi bi-heart-pulse"></i> Conditions</h3><p>${
          mh.conditions || "None reported"
        }</p></div>
        <div class="mh-card"><h3><i class="bi bi-exclamation-triangle"></i> Allergies</h3><p>${
          mh.allergies || "None reported"
        }</p></div>
        <div class="mh-card"><h3><i class="bi bi-capsule"></i> Medications</h3><p>${
          mh.medications || "None reported"
        }</p></div>
        <div class="mh-card small"><h3><i class="bi bi-wind"></i> Smoking</h3><p>${
          mh.smokingStatus || "-"
        }</p></div>
        <div class="mh-card small"><h3><i class="bi bi-cup-straw"></i> Alcohol</h3><p>${
          mh.alcoholConsumption || "-"
        }</p></div>
        <div class="mh-card small"><h3><i class="bi bi-rulers"></i> Height</h3><p>${
          mh.heightCm ? mh.heightCm + " cm" : "-"
        }</p></div>
        <div class="mh-card small"><h3><i class="bi bi-weight"></i> Weight</h3><p>${
          mh.weightKg ? mh.weightKg + " kg" : "-"
        }</p></div>
        <div class="mh-card small"><h3><i class="bi bi-droplet-half"></i> Blood Type</h3><p>${
          mh.bloodType || "-"
        }</p></div>
        <div class="mh-card full"><h3><i class="bi bi-journal-text"></i> Notes</h3><p>${
          mh.notes || "No additional notes."
        }</p></div>
      </div>
    `;

          const apptDiv = document.getElementById("mh-appointments");
          apptDiv.innerHTML =
            mh.appointments && mh.appointments.length > 0
              ? mh.appointments
                  .map(
                    (a) =>
                      `<div class="card" style="margin-bottom:10px;"><strong>${
                        a.doctor?.user?.username || "Doctor"
                      }</strong><br/>${new Date(
                        a.date
                      ).toLocaleString()}<br/><span class="muted">${
                        a.reason || ""
                      }</span></div>`
                  )
                  .join("")
              : "No past appointments.";

          const labDiv = document.getElementById("mh-labs");
          labDiv.innerHTML =
            mh.labResults && mh.labResults.length > 0
              ? mh.labResults
                  .map(
                    (l) =>
                      `<div class="card" style="margin-bottom:10px;"><strong>${
                        l.testName
                      }</strong><br/>Result: ${l.result}<br/>Date: ${new Date(
                        l.date
                      ).toLocaleDateString()}</div>`
                  )
                  .join("")
              : "No lab results.";
        }
        document
          .querySelector('a[data-section="history"]')
          ?.addEventListener("click", fetchMedicalHistory);

        // ---------------------------
        // PRESCRIPTIONS
        // ---------------------------
        let rxAll = [];
        async function fetchRx() {
          const data = await fetchJson(`/prescriptions/patient/${myId}`);
          rxAll = data || [];
          renderRx(rxAll);
        }

        function renderRx(items) {
          const container = document.getElementById("rx-list");
          const empty = document.getElementById("rx-empty");
          if (!container) return;
          container.innerHTML = "";
          if (!items || items.length === 0) {
            if (empty) empty.style.display = "";
            return;
          }
          if (empty) empty.style.display = "none";
          items.forEach((rx) => {
            const card = document.createElement("div");
            card.className = "card col-4";
            const name = rx.medicationName || "-";
            const doctor = rx.doctor?.username || "-";
            const status = rx.status || rx.prescriptionStatus?.name || "-";
            const date = rx.date || rx.createdAt || rx.issueDate || null;
            const canRequestRefill = status !== "PENDING";
            card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>${name}</strong>
          <span class="muted" style="font-size:12px;">${status}</span>
        </div>
        <div class="muted" style="margin-top:6px;">Doctor: ${doctor}</div>
        ${
          date
            ? `<div class="muted" style="margin-top:4px;">Date: ${new Date(
                date
              ).toLocaleDateString()}</div>`
            : ""
        }
        <div style="margin-top:8px;" class="actions-row">
          ${
            canRequestRefill
              ? '<button class="btn request-refill">Request refill</button>'
              : ""
          }
        </div>
      `;
            container.appendChild(card);
          });
        }
        document
          .querySelector('a[data-section="prescriptions"]')
          ?.addEventListener("click", fetchRx);
        setTimeout(fetchRx, 500);

        // ---------------------------
        // PROFILE UPDATE
        // ---------------------------
        document
          .getElementById("profile-form")
          ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const body = {
              username: document.getElementById("inp-name").value.trim(),
              email: document.getElementById("inp-email").value.trim(),
              phoneNumber: document.getElementById("inp-phone").value.trim(),
              role: payload.role,
            };
            try {
              const res = await fetch(`/users/${myId}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
              });
              const statusEl = document.getElementById("profile-status");
              statusEl.textContent = res.ok
                ? "Saved"
                : `Error: ${(await res.text()) || res.status}`;
              loadUserDetails();
            } catch {
              document.getElementById("profile-status").textContent =
                "Network error";
            }
          });

        document
          .getElementById("password-form")
          ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const current = document.getElementById("pwd-current").value;
            const next = document.getElementById("pwd-new").value;
            if (!current || !next)
              return (document.getElementById("password-status").textContent =
                "Enter both passwords");
            try {
              const res = await fetch("/auth/change-password", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  currentPassword: current,
                  newPassword: next,
                }),
              });
              document.getElementById("password-status").textContent = res.ok
                ? "Password updated"
                : `Error: ${(await res.text()) || res.status}`;
            } catch {
              document.getElementById("password-status").textContent =
                "Network error";
            }
          });

        // ---------------------------
        // MAP & DOCTORS
        // ---------------------------
        let map,
          doctorMarkers = [],
          allDoctors = [],
          userLocation = null;

        function clearMarkers() {
          doctorMarkers.forEach((m) => map.removeLayer(m));
          doctorMarkers = [];
        }

        async function geocodeAddress(address) {
          const defaultLocation = { lat: 34.0, lng: 9.0 };
          if (!address) return defaultLocation;
          try {
            const res = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                address
              )}`,
              { headers: { "User-Agent": "MyApp/1.0 (myemail@example.com)" } }
            );
            const data = await res.json();
            return data.length > 0
              ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }
              : defaultLocation;
          } catch {
            return defaultLocation;
          }
        }

        function addDoctorMarker(doc, location) {
          if (!location) return;
          const marker = L.marker([location.lat, location.lng]).addTo(map);
          const popupHtml = `<strong>${escapeHtml(
            doc.user?.username || "Unknown"
          )}</strong><br/>${escapeHtml(
            doc.specialization || ""
          )}<br/>${escapeHtml(doc.hospital?.address || doc.address || "")}`;
          marker.bindPopup(popupHtml);
          doctorMarkers.push(marker);
        }

        async function fetchAndRenderDoctors() {
          clearMarkers();
          allDoctors = (await fetchJson("/api/doctors")) || [];
          for (const doc of allDoctors) {
            const addr = doc.hospital?.address || doc.address || "";
            const loc = await geocodeAddress(addr);
            addDoctorMarker(doc, loc);
          }
        }

        function initMap() {
          if (map) return;
          map = L.map("doctor-map").setView([0, 0], 2);
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          }).addTo(map);
          if (navigator.geolocation)
            navigator.geolocation.getCurrentPosition((pos) => {
              userLocation = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
              };
              map.setView([userLocation.lat, userLocation.lng], 12);
            });
        }

        document
          .querySelector('a[data-section="search"]')
          ?.addEventListener("click", () => {
            initMap();
            fetchAndRenderDoctors();
          });
      })();
    </script>
  </body>
</html>
